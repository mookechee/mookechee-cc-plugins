---
description: 从需求文档生成测试用例。支持飞书项目单URL、飞书云文档URL或本地文件路径。采用四阶段工作流：需求分析→测试点生成→用例设计→智能优化。
---

# 生成测试用例

从需求来源 "$ARGUMENTS" 自动生成 **混合结构 Markdown** 格式的测试用例（可用 markmap 渲染）。

## 使用方法

```bash
# 从飞书项目单生成
/casepilot:generate https://project.feishu.cn/xxx/story/detail/xxx

# 从飞书云文档生成
/casepilot:generate https://xxx.feishu.cn/docx/xxx

# 从本地文件生成
/casepilot:generate ./docs/requirement.md
```

---

## 执行流程（必须严格按顺序执行）

### 步骤 1: 解析输入来源

根据 `$ARGUMENTS` 判断输入类型：

**类型1：飞书项目单 URL**（包含 `project.feishu.cn` 和 `story/detail`）

从 URL 提取：
- `project_key`: 空间标识（如 `uts5wn`）
- `work_item_id`: 工作项 ID（如 `6589464068`）

URL 格式：`https://project.feishu.cn/{project_key}/story/detail/{work_item_id}`

**类型2：飞书云文档 URL**（包含 `.feishu.cn/docx/` 或 `.feishu.cn/wiki/`）

从 URL 提取 `doc_token`（链接最后一段）

**类型3：本地文件路径**

使用 Read 工具读取文件内容

### 步骤 2: 获取需求内容

#### 飞书项目单

调用 `mcp__lark-prj-remote__get_workitem_brief`：

```
project_key: {提取的project_key}
work_item_id: {提取的work_item_id}
fields: ["description", "field_803289", "field_13a9cf", "wiki", "name"]
```

字段说明：
- `name`: 工作项名称
- `description`: 需求描述
- `field_803289`: 验收标准
- `field_13a9cf`: 技术设计文档链接（可能包含多个链接）

#### 飞书云文档

调用 `mcp__lark-mcp-remote__docs_v1_content_get`：

```
query:
  doc_token: {提取的doc_token}
  doc_type: docx
  content_type: markdown
```

#### 本地文件

使用 Read 工具直接读取

### 步骤 3: 读取技术设计文档（必须）

**【重要】此步骤必须执行，不可跳过！**

如果存在技术设计文档链接（`field_13a9cf`）：

#### 3.1 提取所有文档链接

从 `field_13a9cf` 字段中提取所有文档链接。可能的格式：
- 多个链接用空格分隔
- 多个链接用换行分隔
- Markdown 链接格式：`[文档名](URL)`

**示例**：
```
https://vvbwj1rjubu.feishu.cn/wiki/AZwpwCGpUi3rhwkp0SwcqfeNnjh https://vvbwj1rjubu.feishu.cn/wiki/E6fawjBeViLna9ku18ocXppqnNd
```
应提取出 **2 个链接**，并 **全部读取**。

#### 3.2 区分链接类型并读取

| 链接类型 | URL 特征 | doc_type 参数 |
|----------|----------|---------------|
| 新版文档 | 包含 `/docx/` | `docx` |
| 知识库文档 | 包含 `/wiki/` | `docx` |

**读取方法**：

对每个链接调用 `mcp__lark-mcp-remote__docs_v1_content_get`：

```
query:
  doc_token: {从链接提取的token}
  doc_type: docx
  content_type: markdown
```

#### 3.3 识别文档类型并分类

读取文档内容后，根据内容特征分类：

| 文档类型 | 内容特征 | 测试关注点 |
|----------|----------|-----------|
| **PRD文档** | 包含UI设计、交互设计、界面布局、用户流程图 | 界面布局、组件显示、交互操作、状态显示 |
| **技术架构文档** | 包含技术架构、模块设计、接口定义、状态机、协议规范 | 功能实现、状态转换、接口调用、错误处理 |

**输出示例**：
```
已读取 2 个技术文档：
1. PRD文档：wuji-studio固件升级UI设计方案
   - 包含：UI布局、交互流程、状态显示规范
2. 技术架构文档：wuji-studio固件升级代码迁移设计
   - 包含：组件结构、状态定义、错误码映射
```

### 步骤 4: 阶段一 - 需求分析（0-25%）

**角色定位：** 你是专业的需求分析专家，专精于软件需求拆分与测试规划。

**分析流程：**

1. **需求理解**
   - 通读全部文档（需求描述 + 验收标准 + 技术文档）
   - 理解业务背景和核心目标
   - **特别关注 PRD 文档中的 UI/交互设计**

2. **需求拆分**
   - 按功能模块拆分
   - 确保每个需求点独立、可测试
   - **PRD 中的每个 UI 组件/交互流程都应对应需求点**

3. **优先级评估**
   - P0：核心功能，必须实现
   - P1：重要功能，应该实现
   - P2：辅助功能，可选实现

4. **质量检查**
   - 确保无遗漏、无重复、无歧义
   - **确保 PRD 中的 UI 元素已全部覆盖**

**输出格式：**
```markdown
## 需求点列表

**入口与导航模块**
1. [P0] Activity Bar 显示固件升级图标，点击进入升级页面 - 入口与导航

**设备列表模块**
2. [P0] 自动识别并列出所有已连接设备 - 设备列表
3. [P0] 设备卡片显示完整信息（名称、类型、版本、更新标识） - 设备列表
...

共 {N} 个需求点，其中 P0: {X} 个，P1: {Y} 个，P2: {Z} 个
```

**完成后：** 向用户展示需求点列表，**询问用户确认后**继续下一阶段。

### 步骤 5: 用户确认 - 需求点确认

**【重要】此步骤为用户交互点，必须等待用户确认！**

使用 `AskUserQuestion` 工具询问用户：

```
以上需求点列表是否符合预期？是否需要调整或补充？

选项：
1. 确认无误，继续生成测试点
2. 需要补充需求点（请说明）
3. 需要删减需求点（请说明）
```

**用户确认后**，继续执行步骤 6。

### 步骤 6: 梳理用户操作流程

**【重要】此步骤为内部分析，帮助设计更完整的测试用例**

在生成测试点前，先梳理用户的完整操作流程：

#### 6.1 识别主要功能模块

```
模块1: 入口与导航
模块2: 设备列表
模块3: 固件选择
模块4: 升级流程
模块5: 结果反馈
```

#### 6.2 绘制用户操作路径

```
用户流程图（内部思考）：

[进入升级页面]
    ↓
[查看设备列表] → [无设备] → [显示等待提示]
    ↓
[选择设备] → [设备离线] → [禁用升级按钮]
    ↓
[查看固件信息]
    ↓
[选择固件来源] → [在线获取] / [本地导入]
    ↓
[点击升级] → [升级中] → [成功] / [失败]
    ↓
[查看结果] → [重试] / [升级其他设备]
```

#### 6.3 识别状态切换点

```
设备状态：在线 → 离线 → 升级中 → 成功/失败
升级步骤：选择设备 → 选择固件 → 执行升级 → 完成
OTA状态：idle → receiving → verifying → rebooting → completed/failed
```

**此步骤不输出给用户，仅作为后续测试点设计的参考。**

### 步骤 7: 阶段二 - 测试点生成（25-50%）

**角色定位：** 你是资深测试架构师，擅长设计全面且高效的测试策略。

**核心原则：**

- **二八法则**：每个需求点生成 3-8 个测试点，覆盖 80% 核心业务的 20% 关键场景
- **基于用户流程**：根据步骤 6 梳理的用户操作流程设计测试点

**测试分类：**

| 分类 | 说明 | 典型优先级 |
|------|------|-----------|
| PRD UI/交互设计测试 | 界面布局、组件显示、交互操作 | P0 |
| 功能测试 | 核心功能验证 | P0 |
| 状态切换测试 | 状态转换正确性 | P0-P1 |
| 边界值测试 | 最大值、最小值、默认值 | P1 |
| 异常场景测试 | 错误处理、异常恢复 | P0-P1 |
| 兼容性测试 | 新旧版本兼容、多平台、多配置（详见下方指引） | P0-P1 |
| 性能测试 | 响应时间、吞吐量、资源占用 | P1-P2 |
| 安全测试 | 权限控制、数据安全、输入校验 | P1 |
| 稳定性测试 | 重复操作、极端场景 | P2 |

**兼容性测试设计指引（重点）：**

软件/固件兼容性是版本迭代中的关键测试领域，必须重点关注：

| 兼容场景 | 说明 | 典型优先级 |
|----------|------|-----------|
| 新软件+旧固件 | 新版本软件与旧版本固件的协同工作 | P0 |
| 旧软件+新固件 | 旧版本软件与新版本固件的协同工作 | P0 |
| 新软件+新固件 | 新版本软件与新版本固件的协同工作 | P0 |
| 协议版本兼容 | 不同协议版本之间的通信兼容性 | P0 |
| 数据格式兼容 | 新旧数据格式的读取/写入/转换 | P0-P1 |
| 配置兼容 | 旧配置在新版本中的读取和迁移 | P1 |
| API兼容 | 接口变更对调用方的影响 | P0-P1 |
| 升级路径 | 从旧版本升级到新版本的过程验证 | P0 |
| 降级回滚 | 从新版本回退到旧版本的能力 | P1 |

**设计方法：**
- 等价类划分
- 边界值分析
- 状态转换测试
- 错误猜测

**输出格式：**
```markdown
## 测试点列表

### 需求点 RP-001（入口与导航）的测试点：
- TP-001 [P0] Activity Bar 图标显示正确 - PRD UI/交互设计测试
- TP-002 [P0] 点击升级图标进入升级页面 - 功能测试

### 需求点 RP-002~005（设备列表）的测试点：
- TP-003 [P0] 自动识别已连接设备并显示列表 - 功能测试
- TP-004 [P0] 设备卡片显示名称、类型、固件版本、更新标识 - PRD UI/交互设计测试
...

共 {N} 个测试点，其中 P0: {X} 个，P1: {Y} 个，P2: {Z} 个
```

**完成后：** 向用户展示测试点列表，**询问用户确认后**继续下一阶段。

### 步骤 8: 用户确认 - 测试点确认

**【重要】此步骤为用户交互点，必须等待用户确认！**

使用 `AskUserQuestion` 工具询问用户：

```
以上测试点列表是否符合预期？是否需要调整或补充？

选项：
1. 确认无误，继续生成测试用例
2. 需要补充测试点（请说明）
3. 需要删减测试点（请说明）
```

**用户确认后**，继续执行步骤 9。

### 步骤 9: 阶段三 - 用例设计（50-85%）

**角色定位：** 你是经验丰富的测试用例设计专家。

**核心原则：**

- 每个测试点对应一个测试用例
- 用例结构：用例名称 → 前置条件 → 执行步骤 → 预期结果 → 优先级
- **步骤简洁**：每个用例的执行步骤控制在 1-3 句话，聚焦关键操作

**用例编写规范：**

| 要素 | 说明 | 示例 |
|------|------|------|
| 用例名称 | 简洁明了，格式：`验证{功能点}{测试场景}` | `验证登录功能-正确密码登录成功` |
| 前置条件 | 测试开始前必须满足的条件 | `用户已注册，处于登出状态` |
| 执行步骤 | 具体操作步骤，简洁描述 | `输入正确用户名和密码，点击登录按钮` |
| 预期结果 | 明确、可量化、可观测 | `登录成功，跳转到首页，显示用户信息` |
| 优先级 | P0/P1/P2 | `P0` |

### 步骤 10: 阶段四 - 智能优化（85-100%）

**角色定位：** 你是资深测试专家，负责测试用例的质量评估和优化。

**验收标准覆盖检查（必须）：**

逐条分析验收标准，确保每条验收标准都有对应的测试用例：

```
验收标准1 → 测试用例1, 测试用例2, ...
验收标准2 → 测试用例3, 测试用例4, ...
```

**优化策略：**

- 补充遗漏的验收标准覆盖
- 检查用例描述是否清晰
- 确保优先级分配合理

### 步骤 11: 生成 Markdown 文件

生成的 Markdown 文件必须采用 **混合结构格式**（标题 + 无序列表），以便 markmap 正确渲染 7 层链式结构：

**层级格式规范：**

| 层级 | 内容 | 格式 |
|------|------|------|
| L1 | 文档标题 | `# ` |
| L2 | 模块名 | `## ` |
| L3 | 用例名 | `### ` |
| L4 | 前置条件 | `- ` |
| L5 | 测试步骤 | `  - ` (2空格缩进) |
| L6 | 预期结果 | `    - ` (4空格缩进) |
| L7 | 优先级 | `      - ` (6空格缩进) |

**示例：**

```markdown
# Wuji Hand ROS2 驱动测试用例

## 1. 概述功能测试

### 验证关节状态发布频率为1000Hz
- 已安装 ROS2 驱动，灵巧手设备已连接
  - 启动驱动，使用 ros2 topic hz 命令测量 joint_states 发布频率
    - 发布频率稳定在 1000Hz 左右（允许 5% 误差）
      - P0

### 验证Topic实时控制接口可用
- 驱动已启动，设备已连接
  - 向 joint_commands Topic 发布位置命令，观察手指响应
    - 手指按照命令移动到指定位置，延迟小于 10ms
      - P0

## 2. 边界值测试

### 验证关节角度最大值边界
- 驱动已启动，设备已连接
  - 发送关节角度为最大值的命令
    - 手指移动到最大角度位置，不超限
      - P1
```

**关键要求：**
- 每条用例是一个 7 层链式结构：`标题 → 模块 → 用例名称 → 前置条件 → 执行步骤 → 预期结果 → 优先级`
- L3 用例名使用 `### ` 三级标题
- L4-L7 使用无序列表 `-`，通过缩进（2空格递增）表示层级
- 优先级使用大写 P + 数字：P0、P1、P2

### 步骤 12: 保存文件

将 Markdown 文件保存到：`~/Testcase/markmap/{工作项名称}_测试用例_{时间戳}.md`

时间戳格式：`YYYYMMDD_HHmmss`（如 `20250106_143052`）

如果目录不存在，先创建目录。

### 步骤 13: 测试覆盖度检查（必须）

**角色定位：** 你是质量保证专家，负责验证测试用例的完整性和覆盖度。

**此步骤为必须执行步骤，不可跳过！**

生成测试用例后，必须进行全面的覆盖度检查，确保测试用例能够覆盖所有关键测试点。

#### 13.1 文档覆盖度检查

逐一检查以下文档中提到的测试点是否已被覆盖：

| 检查项 | 检查内容 | 覆盖要求 |
|--------|----------|----------|
| 技术设计文档 | 架构设计、接口定义、模块交互、状态机、协议规范 | 100% 覆盖 |
| 验收标准 | 每条验收标准对应的测试场景 | 100% 覆盖 |
| PRD文档 | UI设计、交互流程、业务规则 | 100% 覆盖 |
| 其他关联单据 | 关联的Bug、需求变更、技术评审意见 | 按需覆盖 |

#### 13.2 测试类型覆盖度检查

确保已提供以下类型的测试用例（根据需求特点选择适用项）：

| 测试类型 | 检查要点 | 是否必须 |
|----------|----------|----------|
| 功能测试 | 核心功能正向流程、分支流程 | 必须 |
| PRD UI/交互设计测试 | 界面布局、组件显示、交互操作 | 有PRD时必须 |
| 边界值测试 | 最大/最小值、空值、特殊字符 | 必须 |
| 异常场景测试 | 错误处理、异常恢复、超时处理 | 必须 |
| 兼容性测试 | 新旧软件/固件兼容、版本升级/降级 | 涉及版本时必须 |
| 性能测试 | 响应时间、并发处理、资源占用 | 有性能要求时必须 |
| 安全测试 | 权限校验、数据加密、输入校验 | 涉及安全时必须 |
| 集成测试 | 模块间交互、接口调用 | 涉及多模块时必须 |
| 稳定性测试 | 长时间运行、重复操作、极端场景 | 按需 |

#### 13.3 覆盖度不足时的处理

如果发现覆盖度不足，必须：

1. **补充遗漏的测试用例**：针对未覆盖的测试点设计用例
2. **更新 Markdown 文件**：将补充的用例添加到已生成的文件中
3. **重新统计覆盖度**：确保所有关键测试点已覆盖

### 步骤 14: 输出总结

输出格式化的总结信息：

```markdown
## 需求摘要

**需求名称**：{工作项名称} (m-{work_item_id})
**需求描述**：{description}
**验收标准**：
1. {验收标准1}
2. {验收标准2}
...

## 验收标准覆盖情况

| 验收标准 | 对应测试用例数 | 覆盖状态 |
|----------|---------------|----------|
| {验收标准1} | X | 已覆盖 |
| {验收标准2} | X | 已覆盖 |

## 测试用例统计

| 分类 | 用例数 | P0 | P1 | P2 |
|------|--------|----|----|-----|
| PRD UI/交互设计测试 | X | X | X | X |
| 功能测试 | X | X | X | X |
| 状态切换测试 | X | X | X | X |
| 异常场景测试 | X | X | X | X |
| 兼容性测试 | X | X | X | X |
| 性能测试 | X | X | X | X |
| 安全测试 | X | X | X | X |
| {其他分类} | X | X | X | X |
| **合计** | **X** | **X** | **X** | **X** |

## 测试覆盖度检查报告

### 文档覆盖度

| 文档类型 | 测试点总数 | 已覆盖 | 未覆盖 | 覆盖率 |
|----------|-----------|--------|--------|--------|
| 技术设计文档 | X | X | 0 | 100% |
| 验收标准 | X | X | 0 | 100% |
| PRD文档 | X | X | 0 | 100% |

### 测试类型覆盖度

| 测试类型 | 用例数 | 覆盖状态 |
|----------|--------|----------|
| 功能测试 | X | 已覆盖 |
| PRD UI/交互设计测试 | X | 已覆盖 |
| 边界值测试 | X | 已覆盖 |
| 异常场景测试 | X | 已覆盖 |
| 兼容性测试 | X | 已覆盖/不适用 |
| 性能测试 | X | 已覆盖/不适用 |
| 安全测试 | X | 已覆盖/不适用 |

### 未覆盖项说明（如有）

| 未覆盖测试点 | 原因 | 建议 |
|-------------|------|------|
| {测试点} | {原因} | {建议} |

## 文件路径

`~/Testcase/markmap/{工作项名称}_测试用例_{时间戳}.md`
```

---

## 优先级说明

| 优先级 | 重要性 | 适用场景 |
|--------|--------|----------|
| **P0** | 最高 | 核心功能、验收标准直接相关、主流程、编译验证、PRD UI核心功能 |
| **P1** | 中等 | 重要功能、边界条件、配置验证、异常处理、主题/语言切换 |
| **P2** | 较低 | 辅助功能、极端场景、稳定性测试、可选特性 |

---

## 测试场景设计方法

### 1. 等价类划分
- 有效等价类：正常输入
- 无效等价类：异常输入

### 2. 边界值分析
- 最小值、最小值+1
- 最大值、最大值-1
- 默认值

### 3. 状态转换测试
- 覆盖所有状态
- 覆盖所有转换路径
- 测试无效转换

### 4. 错误猜测
- 文件缺失
- 网络异常
- 权限不足
- 资源不足

---

## 注意事项

1. 确保飞书 MCP 服务已配置并可用
2. 需要有权限访问对应的飞书项目单和云文档
3. **【重要】技术设计文档可能有多个链接，必须全部读取**
4. **【重要】区分 wiki 和 docx 链接类型，使用正确的 doc_type**
5. **【重要】如果存在PRD文档，必须针对其中的UI和交互设计生成测试用例**
6. **【重要】涉及版本迭代时，必须设计新旧软件/固件兼容性测试用例**
7. **【重要】在需求分析和测试点生成后都需要询问用户确认**
8. **【重要】必须执行覆盖度检查步骤，确保测试点完整覆盖**
9. 输出总结时必须展示验收标准的覆盖情况和覆盖度检查报告
10. 生成的 Markdown 文件可用 VS Code markmap 插件或其他 markmap 工具渲染查看
