---
description: 从需求文档生成测试用例。支持飞书项目单URL、飞书云文档URL或本地文件路径。采用7步工作流：解析与获取→分析与策略→用例设计→生成文件→Review审查→覆盖度报告→总结。
---

# 生成测试用例

从需求来源 "$ARGUMENTS" 自动生成 **混合结构 Markdown** 格式的测试用例（可用 markmap 渲染）。

## 使用方法

```bash
# 从飞书项目单生成
/casepilot:generate https://project.feishu.cn/xxx/story/detail/xxx

# 从飞书云文档生成
/casepilot:generate https://xxx.feishu.cn/docx/xxx

# 从本地文件生成
/casepilot:generate ./docs/requirement.md
```

---

## 执行流程（必须严格按顺序执行 7 步）

### 步骤 1: 解析输入与获取需求

将原来的输入解析、需求获取、技术文档读取合并为一步完成。

#### 1.1 解析输入来源

根据 `$ARGUMENTS` 判断输入类型：

| 类型 | URL 特征 | 提取信息 |
|------|----------|----------|
| 飞书项目单 | 包含 `project.feishu.cn` 和 `story/detail` | `project_key`, `work_item_id` |
| 飞书云文档 | 包含 `.feishu.cn/docx/` 或 `.feishu.cn/wiki/` | `doc_token` |
| 本地文件 | 其他路径 | 文件内容 |

URL 格式：`https://project.feishu.cn/{project_key}/story/detail/{work_item_id}`

#### 1.2 获取需求内容

**飞书项目单：**

**MCP 工具调用策略（按优先级尝试）：**
1. 优先使用: `mcp__lark-prj-new__get_workitem_brief`
2. 若失败回退: `mcp__lark-prj-remote__get_workitem_brief`
3. 两者均失败: 提示用户运行 `/casepilot:check-mcp`

**字段自动发现：**
1. 先调用 `mcp__lark-prj-new__get_workitem_info`（或回退 `mcp__lark-prj-remote__get_workitem_info`）获取字段元数据，参数 `work_item_type: "story"`
2. 在返回的字段列表中按名称匹配：`"验收标准"` → 对应 field_key，`"技术设计文档"` → 对应 field_key
3. 匹配失败时回退默认值：验收标准=`field_803289`，技术设计文档=`field_13a9cf`
   **注意**：这些默认值仅适用于特定飞书项目，使用回退值时应向用户发出警告，提示可能需要根据实际项目配置 field_key

调用获取工作项详情：

```
project_key: {提取的project_key}
work_item_id: {提取的work_item_id}
fields: ["description", "{验收标准field_key}", "{技术设计文档field_key}", "name"]
```

字段说明：
- `name`: 工作项名称
- `description`: 需求描述
- 验收标准字段: 验收标准内容
- 技术设计文档字段: 技术设计文档链接（可能包含多个链接）

**飞书云文档：**

调用 `mcp__lark-mcp-remote__docs_v1_content_get`：

```
query:
  doc_token: {提取的doc_token}
  doc_type: docx
  content_type: markdown
```

**本地文件：** 使用 Read 工具直接读取。

#### 1.3 读取技术设计文档（如存在）

**【重要】如存在技术设计文档链接，此步骤必须执行！**

从技术设计文档字段中提取所有文档链接（可能多个，以空格/换行/Markdown 链接格式分隔），**全部读取**。

| 链接类型 | URL 特征 | doc_type 参数 |
|----------|----------|---------------|
| 新版文档 | 包含 `/docx/` | `docx` |
| 知识库文档 | 包含 `/wiki/` | `docx` |

对每个链接调用 `mcp__lark-mcp-remote__docs_v1_content_get`。

读取后根据内容特征分类：

| 文档类型 | 内容特征 | 测试关注点 |
|----------|----------|-----------|
| PRD文档 | UI设计、交互设计、界面布局、用户流程图 | 界面布局、组件显示、交互操作、状态显示 |
| 技术架构文档 | 技术架构、模块设计、接口定义、状态机、协议规范 | 功能实现、状态转换、接口调用、错误处理 |

**输出：** 仅输出简短摘要（不超过 5 行），例如：

```
已获取需求「{工作项名称}」，包含 {N} 条验收标准，读取了 {M} 个技术文档。
```

---

### 步骤 2: 需求分析与测试策略

将需求分析、流程梳理、测试点生成合并为一步，仅输出精简摘要。

#### 2.1 需求分析（内部处理，不输出完整列表）

**角色定位：** 专业需求分析专家。

- 通读全部文档（需求描述 + 验收标准 + 技术文档）
- 按功能模块拆分需求点，确保每个需求点独立、可测试
- PRD 中的每个 UI 组件/交互流程都应对应需求点
- 评估优先级：P0（核心）、P1（重要）、P2（辅助）

#### 2.2 操作流程梳理（内部处理，不输出）

- 识别主要功能模块
- 绘制用户操作路径（主流程、分支流程、异常流程）
- 识别状态切换点（初始状态、中间状态、终止状态）

#### 2.3 测试策略制定（内部处理，不输出完整列表）

**角色定位：** 资深测试架构师。

**核心原则：**
- **二八法则**：每个需求点生成 3-8 个测试点
- **基于用户流程**：根据操作流程设计测试点

**测试分类：**

| 分类 | 说明 | 典型优先级 |
|------|------|-----------|
| PRD UI/交互设计测试 | 界面布局、组件显示、交互操作 | P0 |
| 功能测试 | 核心功能验证 | P0 |
| 状态切换测试 | 状态转换正确性 | P0-P1 |
| 边界值测试 | 最大值、最小值、默认值 | P1 |
| 异常场景测试 | 错误处理、异常恢复 | P0-P1 |
| 兼容性测试 | 新旧版本兼容、多平台、多配置 | P0-P1 |
| 性能测试 | 响应时间、吞吐量、资源占用 | P1-P2 |
| 安全测试 | 权限控制、数据安全、输入校验 | P1 |
| 稳定性测试 | 重复操作、极端场景 | P2 |

**兼容性测试设计指引：**

涉及版本迭代时，必须覆盖：新软件+旧固件、旧软件+新固件、协议版本兼容、数据格式兼容、升级路径、降级回滚。

**测试设计方法：** 等价类划分、边界值分析、状态转换测试、错误猜测。

#### 2.4 输出分析摘要并请求用户确认

**【唯一确认点】** 输出精简分析摘要（非完整列表），格式：

```markdown
## 分析摘要

**功能模块**: {模块1}、{模块2}、{模块3}...
**需求点**: 共 {N} 个（P0: {X}, P1: {Y}, P2: {Z}）
**测试点**: 共 {M} 个（P0: {A}, P1: {B}, P2: {C}）
**测试类型覆盖**: 功能、UI/交互、边界值、异常、{其他适用类型}
**验收标准**: 共 {K} 条，全部已匹配测试点
```

使用 `AskUserQuestion` 询问用户：

```
以上分析摘要是否符合预期？

选项：
1. 确认无误，继续生成测试用例
2. 需要调整（请说明）
```

**用户确认后**，继续执行步骤 3。

---

### 步骤 3: 用例设计与覆盖度验证

将用例设计、智能优化、覆盖度检查合并，边设计边验证。

#### 3.1 用例设计

**角色定位：** 经验丰富的测试用例设计专家。

**核心原则：**
- 每个测试点对应一个测试用例
- 用例结构：用例名称 → 前置条件 → 执行步骤 → 预期结果 → 优先级
- **步骤简洁**：每个用例的执行步骤控制在 1-3 句话

**用例编写规范（参照 TEMPLATE.md）：**

| 要素 | 说明 | 示例 |
|------|------|------|
| 用例名称 | `验证{功能}{场景}`，**≤35 字符，禁止编号前缀** | `验证登录功能正确密码成功` |
| 前置条件 | 测试开始前必须满足的条件 | `用户已注册，处于登出状态` |
| 执行步骤 | 具体操作步骤，简洁描述 | `输入正确用户名和密码，点击登录` |
| 预期结果 | 明确、可量化、可观测 | `登录成功，跳转首页，显示用户信息` |
| 优先级 | P0/P1/P2 | `P0` |

#### 3.2 边设计边验证覆盖度

在设计过程中同步进行覆盖度验证：

1. **验收标准覆盖**：逐条检查每条验收标准是否有对应用例
2. **文档覆盖**：技术设计文档、PRD 中的关键功能点是否已覆盖
3. **测试类型覆盖**：确保所有适用的测试类型都已设计用例

发现遗漏立即补充，无需事后回头。

#### 3.3 智能优化

- 检查用例描述是否清晰可执行
- 确保优先级分配合理
- 去除重复用例

**此步骤不向用户输出中间结果，直接进入步骤 4。**

---

### 步骤 4: 生成 Markdown 文件

#### 4.1 生成文件内容

生成的 Markdown 文件采用 **混合结构格式**（标题 + 无序列表），格式参照 `TEMPLATE.md`。

**层级格式规范：**

| 层级 | 内容 | 格式 |
|------|------|------|
| L1 | 文档标题 | `# ` |
| L2 | 模块名 | `## {N}. {模块名}` |
| L3 | 用例名 | `### ` |
| L4 | 前置条件 | `- ` |
| L5 | 测试步骤 | `  - ` (2空格缩进) |
| L6 | 预期结果 | `    - ` (4空格缩进) |
| L7 | 优先级 | `      - ` (6空格缩进) |

**模块编号规范：** 统一使用 `## {N}. {模块名}` 格式（如 `## 1. 功能测试`、`## 2. 边界值测试`），序号从 1 开始连续递增。

**用例命名规范：**
- 格式：`验证{功能}{场景}`
- 长度：≤35 字符
- 禁止编号前缀（如 `1.`、`TC001`）

**示例：**

```markdown
# Wuji Hand ROS2 驱动测试用例

## 1. 功能测试

### 验证关节状态发布频率1000Hz
- 已安装 ROS2 驱动，灵巧手设备已连接
  - 启动驱动，使用 ros2 topic hz 命令测量 joint_states 发布频率
    - 发布频率稳定在 1000Hz 左右（允许 5% 误差）
      - P0

### 验证Topic实时控制接口可用
- 驱动已启动，设备已连接
  - 向 joint_commands Topic 发布位置命令，观察手指响应
    - 手指按照命令移动到指定位置，延迟小于 10ms
      - P0

## 2. 边界值测试

### 验证关节角度最大值边界
- 驱动已启动，设备已连接
  - 发送关节角度为最大值的命令
    - 手指移动到最大角度位置，不超限
      - P1
```

#### 4.2 保存文件

保存到：`~/Testcase/markmap/{工作项名称}_测试用例_{时间戳}.md`

时间戳格式：`YYYYMMDD_HHmmss`（如 `20250106_143052`）

如果目录不存在，先创建目录。

---

### 步骤 5: Review 审查

#### 5.1 检测 superpowers 插件

检查 superpowers 插件是否可用（通过检查 `superpowers:code-reviewer` 是否在可用 skills 列表中）。

**已安装**: 继续执行 5.2

**未安装**: 提示用户：

```
Review 审查需要 superpowers 插件支持，当前未检测到。

安装方法：
1. 添加官方市场: /plugin marketplace add anthropics/claude-plugins-official
2. 安装插件: /plugin install superpowers@anthropics/claude-plugins-official
3. 安装完成后重新运行 generate 命令

或跳过 Review 步骤，直接继续。
```

使用 `AskUserQuestion` 询问用户选择：
- 选项1: 跳过 Review，继续下一步
- 选项2: 暂停，先安装 superpowers 插件

#### 5.2 执行 Review 审查

调用 Task tool 启动 `superpowers:code-reviewer` agent 对生成的用例文件进行质量检查。

**审查要点:**
1. 用例格式一致性 — 7层结构是否规范
2. 用例命名规范 — 是否 ≤35 字符，无编号前缀
3. 模块编号统一性 — 是否使用 `## {N}. {模块名}` 格式
4. 覆盖完整性 — 验收标准是否全部对应用例
5. 用例质量 — 前置条件/步骤/预期结果是否清晰可执行

**审查后处理:**
- 如果发现格式问题：自动修复
- 如果发现覆盖遗漏：补充用例并更新文件
- 如果质量符合标准：继续下一步

---

### 步骤 6: 覆盖度报告

输出精简覆盖度报告（表格形式）：

```markdown
## 验收标准覆盖

| 验收标准 | 对应用例数 | 状态 |
|----------|-----------|------|
| {验收标准1} | X | 已覆盖 |
| {验收标准2} | X | 已覆盖 |

## 测试类型覆盖

| 测试类型 | 用例数 | 状态 |
|----------|--------|------|
| 功能测试 | X | 已覆盖 |
| UI/交互测试 | X | 已覆盖 |
| 边界值测试 | X | 已覆盖 |
| 异常场景 | X | 已覆盖 |
| 兼容性测试 | X | 已覆盖/不适用 |
```

---

### 步骤 7: 输出总结

输出精简总结：

```markdown
## 生成完成

**需求**: {工作项名称}
**用例数**: 共 {N} 个（P0: {X}, P1: {Y}, P2: {Z}）
**文件**: `~/Testcase/markmap/{文件名}.md`

## 导入飞书项目

生成的 Markdown 文件可通过 XMind 中转导入飞书项目：
1. 使用 XMind 打开 → 文件 → 导入 → Markdown → 选择生成的 .md 文件
2. 保存为 .xmind 格式
3. 在飞书项目 > 测试管理 > 用例库 > 导入 > XMind 导入（自由模式）
```

---

## 优先级说明

| 优先级 | 重要性 | 适用场景 |
|--------|--------|----------|
| **P0** | 最高 | 核心功能、验收标准直接相关、主流程、PRD UI核心功能 |
| **P1** | 中等 | 重要功能、边界条件、配置验证、异常处理 |
| **P2** | 较低 | 辅助功能、极端场景、稳定性测试 |

---

## 注意事项

1. 确保飞书 MCP 服务已配置并可用
2. 需要有权限访问对应的飞书项目单和云文档
3. **【重要】技术设计文档可能有多个链接，必须全部读取**
4. **【重要】区分 wiki 和 docx 链接类型，使用正确的 doc_type**
5. **【重要】如果存在PRD文档，必须针对其中的UI和交互设计生成测试用例**
6. **【重要】涉及版本迭代时，必须设计新旧软件/固件兼容性测试用例**
7. **【重要】步骤 2 分析摘要后必须等待用户确认**
8. **【重要】用例命名 ≤35 字符，模块编号使用 `## {N}. {模块名}` 格式**
9. 生成的 Markdown 文件可用 VS Code markmap 插件或其他 markmap 工具渲染查看
