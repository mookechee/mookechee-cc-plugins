---
description: 从需求文档生成测试用例。支持飞书项目单URL、飞书云文档URL或本地文件路径。采用四阶段工作流：需求分析→测试点生成→用例设计→智能优化。
---

# 生成测试用例

从需求来源 "$ARGUMENTS" 自动生成 **混合结构 Markdown** 格式的测试用例（可用 markmap 渲染）。

## 使用方法

```bash
# 从飞书项目单生成
/testflow-generator:generate https://project.feishu.cn/xxx/story/detail/xxx

# 从飞书云文档生成
/testflow-generator:generate https://xxx.feishu.cn/docx/xxx

# 从本地文件生成
/testflow-generator:generate ./docs/requirement.md
```

---

## 执行流程（必须严格按顺序执行）

### 步骤 1: 解析输入来源

根据 `$ARGUMENTS` 判断输入类型：

**类型1：飞书项目单 URL**（包含 `project.feishu.cn` 和 `story/detail`）

从 URL 提取：
- `project_key`: 空间标识（如 `uts5wn`）
- `work_item_id`: 工作项 ID（如 `6589464068`）

URL 格式：`https://project.feishu.cn/{project_key}/story/detail/{work_item_id}`

**类型2：飞书云文档 URL**（包含 `.feishu.cn/docx/`）

从 URL 提取 `doc_token`（链接最后一段）

**类型3：本地文件路径**

使用 Read 工具读取文件内容

### 步骤 2: 获取需求内容

#### 飞书项目单

调用 `mcp__lark-prj-remote__get_workitem_brief`：

```
project_key: {提取的project_key}
work_item_id: {提取的work_item_id}
fields: ["description", "field_803289", "field_13a9cf", "wiki"]
```

字段说明：
- `description`: 需求描述
- `field_803289`: 验收标准
- `field_13a9cf`: 技术设计文档链接

#### 飞书云文档

调用 `mcp__lark-mcp-remote__docs_v1_content_get`：

```
query:
  doc_token: {提取的doc_token}
  doc_type: docx
  content_type: markdown
```

#### 本地文件

使用 Read 工具直接读取

### 步骤 3: 读取技术设计文档（可选）

如果存在技术设计文档链接（`field_13a9cf`）：

1. 从链接中提取 doc_token
2. **注意：可能存在多个文档链接，需要全部读取**
3. 调用 `mcp__lark-mcp-remote__docs_v1_content_get` 获取内容
4. **识别文档类型并分类**：
   - PRD文档：包含UI设计、交互设计、界面布局
   - 架构设计文档：包含技术架构、模块设计、接口定义

### 步骤 4: 阶段一 - 需求分析（0-25%）

**角色定位：** 你是专业的需求分析专家，专精于软件需求拆分与测试规划。

**分析流程：**

1. **需求理解**
   - 通读全文，理解业务背景
   - 识别核心功能和业务目标

2. **需求拆分**
   - 按功能模块拆分
   - 确保每个需求点独立、可测试

3. **优先级评估**
   - P0：核心功能，必须实现
   - P1：重要功能，应该实现
   - P2：辅助功能，可选实现

4. **质量检查**
   - 确保无遗漏、无重复、无歧义

**输出格式：**
```
需求点列表：
1. [P0] {需求点描述} - {所属模块}
2. [P1] {需求点描述} - {所属模块}
...
```

**完成后：** 向用户展示需求点列表，然后自动继续下一阶段。

### 步骤 5: 阶段二 - 测试点生成（25-50%）

**角色定位：** 你是资深测试架构师，擅长设计全面且高效的测试策略。

**核心原则：**

- **二八法则**：每个需求点生成 3-8 个测试点，覆盖 80% 核心业务的 20% 关键场景

**测试分类：**

| 分类 | 说明 | 典型优先级 |
|------|------|-----------|
| PRD UI/交互设计测试 | 界面布局、组件显示、交互操作 | P0 |
| 功能测试 | 核心功能验证 | P0 |
| 状态切换测试 | 状态转换正确性 | P0-P1 |
| 边界值测试 | 最大值、最小值、默认值 | P1 |
| 异常场景测试 | 错误处理、异常恢复 | P0-P1 |
| 兼容性测试 | 新旧版本兼容、多平台、多配置（详见下方指引） | P0-P1 |
| 性能测试 | 响应时间、吞吐量、资源占用 | P1-P2 |
| 安全测试 | 权限控制、数据安全、输入校验 | P1 |
| 稳定性测试 | 重复操作、极端场景 | P2 |

**兼容性测试设计指引（重点）：**

软件/固件兼容性是版本迭代中的关键测试领域，必须重点关注：

| 兼容场景 | 说明 | 典型优先级 |
|----------|------|-----------|
| 新软件+旧固件 | 新版本软件与旧版本固件的协同工作 | P0 |
| 旧软件+新固件 | 旧版本软件与新版本固件的协同工作 | P0 |
| 新软件+新固件 | 新版本软件与新版本固件的协同工作 | P0 |
| 协议版本兼容 | 不同协议版本之间的通信兼容性 | P0 |
| 数据格式兼容 | 新旧数据格式的读取/写入/转换 | P0-P1 |
| 配置兼容 | 旧配置在新版本中的读取和迁移 | P1 |
| API兼容 | 接口变更对调用方的影响 | P0-P1 |
| 升级路径 | 从旧版本升级到新版本的过程验证 | P0 |
| 降级回滚 | 从新版本回退到旧版本的能力 | P1 |

**兼容性测试用例设计要点：**

1. **版本矩阵覆盖**：列出所有需要支持的版本组合
2. **关键功能验证**：在每个版本组合下验证核心功能
3. **边界版本测试**：重点测试最老支持版本和最新版本的组合
4. **升级场景测试**：验证各种升级路径的正确性
5. **数据迁移测试**：确保数据在版本间正确迁移

**设计方法：**
- 等价类划分
- 边界值分析
- 状态转换测试
- 错误猜测

**输出格式：**
```
需求点 RP-001 的测试点：
- TP-001 [P0] {测试点描述} - {测试类型}
- TP-002 [P1] {测试点描述} - {测试类型}
...
```

**完成后：** 向用户展示测试点列表，然后自动继续下一阶段。

### 步骤 6: 阶段三 - 用例设计（50-85%）

**角色定位：** 你是经验丰富的测试用例设计专家。

**核心原则：**

- 每个测试点对应一个测试用例
- 用例结构：用例名称 → 前置条件 → 执行步骤 → 预期结果 → 优先级
- **步骤简洁**：每个用例的执行步骤控制在 1-3 句话，聚焦关键操作

**用例编写规范：**

| 要素 | 说明 | 示例 |
|------|------|------|
| 用例名称 | 简洁明了，格式：`{功能点}{测试场景}` | `登录功能-正确密码登录成功` |
| 前置条件 | 测试开始前必须满足的条件 | `用户已注册，处于登出状态` |
| 执行步骤 | 具体操作步骤，简洁描述 | `输入正确用户名和密码，点击登录按钮` |
| 预期结果 | 明确、可量化、可观测 | `登录成功，跳转到首页，显示用户信息` |
| 优先级 | P0/P1/P2 | `P0` |

### 步骤 7: 阶段四 - 智能优化（85-100%）

**角色定位：** 你是资深测试专家，负责测试用例的质量评估和优化。

**验收标准覆盖检查（必须）：**

逐条分析验收标准，确保每条验收标准都有对应的测试用例：

```
验收标准1 → 测试用例1, 测试用例2, ...
验收标准2 → 测试用例3, 测试用例4, ...
```

**优化策略：**

- 补充遗漏的验收标准覆盖
- 检查用例描述是否清晰
- 确保优先级分配合理

### 步骤 8: 生成 Markdown 文件

生成的 Markdown 文件必须采用 **混合结构格式**（标题 + 无序列表），以便 markmap 正确渲染 7 层链式结构：

**层级格式规范：**

| 层级 | 内容 | 格式 |
|------|------|------|
| L1 | 文档标题 | `# ` |
| L2 | 模块名 | `## ` |
| L3 | 用例名 | `### ` |
| L4 | 前置条件 | `- ` |
| L5 | 测试步骤 | `  - ` (2空���缩进) |
| L6 | 预期结果 | `    - ` (4空格缩进) |
| L7 | 优先级 | `      - ` (6空格缩进) |

**示例：**

```markdown
# Wuji Hand ROS2 驱动测试用例

## 1. 概述功能测试

### 验证关节状态发布频率为1000Hz
- 已安装 ROS2 驱动，灵巧手设备已连接
  - 启动驱动，使用 ros2 topic hz 命令测量 joint_states 发布频率
    - 发布频率稳定在 1000Hz 左右（允许 5% 误差）
      - P0

### 验证Topic实时控制接口可用
- 驱动已启动，设备已连接
  - 向 joint_commands Topic 发布位置命令，观察手指响应
    - 手指按照命令移动到指定位置，延迟小于 10ms
      - P0

## 2. 边界值测试

### 验证关节角度最大值边界
- 驱动已启动，设备已连接
  - 发送关节角度为最大值的命令
    - 手指移动到最大角度位置，不超限
      - P1
```

**关键要求：**
- 每条用例是一个 7 层链式结构：`标题 → 模块 → 用例名称 → 前置条件 → 执行步骤 → 预期结果 → 优先级`
- L3 用例名使用 `### ` 三级标题
- L4-L7 使用无序列表 `-`，通过缩进（2空格递增）表示层级
- 优先级使用大写 P + 数字：P0、P1、P2

### 步骤 9: 保存文件

将 Markdown 文件保存到：`~/Testcase/opml/{工作项名称}_测试用例_markmap_{时间戳}.md`

时间戳格式：`YYYYMMDD_HHmmss`（如 `20250106_143052`）

如果目录不存在，先创建目录。

### 步骤 10: 输出总结

输出格式化的总结信息：

```markdown
## 需求摘要

**需求名称**：{工作项名称} (m-{work_item_id})
**需求描述**：{description}
**验收标准**：
1. {验收标准1}
2. {验收标准2}
...

## 验收标准覆盖情况

| 验收标准 | 对应测试用例数 | 覆盖状态 |
|----------|---------------|----------|
| {验收标准1} | X | 已覆盖 |
| {验收标准2} | X | 已覆盖 |

## 测试用例统计

| 分类 | 用例数 | P0 | P1 | P2 |
|------|--------|----|----|-----|
| PRD UI/交互设计测试 | X | X | X | X |
| 功能测试 | X | X | X | X |
| 兼容性测试 | X | X | X | X |
| 性能测试 | X | X | X | X |
| 安全测试 | X | X | X | X |
| {其他分类} | X | X | X | X |
| **合计** | **X** | **X** | **X** | **X** |

## 文件路径

`~/Testcase/opml/{工作项名称}_测试用例_markmap_{时间戳}.md`
```

### 步骤 11: 测试覆盖度检查（必须）

**角色定位：** 你是质量保证专家，负责验证测试用例的完整性和覆盖度。

**此步骤为必须执行步骤，不可跳过！**

生成测试用例后，必须进行全面的覆盖度检查，确保测试用例能够覆盖所有关键测试点。

#### 11.1 文档覆盖度检查

逐一检查以下文档中提到的测试点是否已被覆盖：

| 检查项 | 检查内容 | 覆盖要求 |
|--------|----------|----------|
| 技术设计文档 | 架构设计、接口定义、模块交互、状态机、协议规范 | 100% 覆盖 |
| 验收标准 | 每条验收标准对应的测试场景 | 100% 覆盖 |
| PRD文档 | UI设计、交互流程、业务规则 | 100% 覆盖 |
| 其他关联单据 | 关联的Bug、需求变更、技术评审意见 | 按需覆盖 |

#### 11.2 测试类型覆盖度检查

确保已提供以下类型的测试用例（根据需求特点选择适用项）：

| 测试类型 | 检查要点 | 是否必须 |
|----------|----------|----------|
| 功能测试 | 核心功能正向流程、分支流程 | 必须 |
| 边界值测试 | 最大/最小值、空值、特殊字符 | 必须 |
| 异常场景测试 | 错误处理、异常恢复、超时处理 | 必须 |
| 兼容性测试 | 新旧软件/固件兼容、版本升级/降级 | 涉及版本时必须 |
| 性能测试 | 响应时间、并发处理、资源占用 | 有性能要求时必须 |
| 安全测试 | 权限校验、数据加密、输入校验 | 涉及安全时必须 |
| 集成测试 | 模块间交互、接口调用 | 涉及多模块时必须 |
| 稳定性测试 | 长时间运行、重复操作、极端场景 | 按需 |

#### 11.3 输出覆盖度报告

在总结末尾追加覆盖度检查报告：

```markdown
## 测试覆盖度检查报告

### 文档覆盖度

| 文档类型 | 测试点总数 | 已覆盖 | 未覆盖 | 覆盖率 |
|----------|-----------|--------|--------|--------|
| 技术设计文档 | X | X | 0 | 100% |
| 验收标准 | X | X | 0 | 100% |
| PRD文档 | X | X | 0 | 100% |

### 测试类型覆盖度

| 测试类型 | 用例数 | 覆盖状态 |
|----------|--------|----------|
| 功能测试 | X | 已覆盖 |
| 边界值测试 | X | 已覆盖 |
| 异常场景测试 | X | 已覆盖 |
| 兼容性测试 | X | 已覆盖/不适用 |
| 性能测试 | X | 已覆盖/不适用 |
| 安全测试 | X | 已覆盖/不适用 |

### 未覆盖项说明（如有）

| 未覆盖测试点 | 原因 | 建议 |
|-------------|------|------|
| {测试点} | {原因} | {建议} |
```

#### 11.4 覆盖度不足时的处理

如果发现覆盖度不足，必须：

1. **补充遗漏的测试用例**：针对未覆盖的测试点设计用例
2. **更新 OPML 文件**：将补充的用例添加到已生成的文件中
3. **重新生成覆盖度报告**：确保所有关键测试点已覆盖

---

## 优先级说明

| 优先级 | 重要性 | 适用场景 |
|--------|--------|----------|
| **P0** | 最高 | 核心功能、验收标准直接相关、主流程、编译验证 |
| **P1** | 中等 | 重要功能、边界条件、配置验证、异常处理 |
| **P2** | 较低 | 辅助功能、极端场景、稳定性测试、可选特性 |

---

## 测试场景设计方法

### 1. 等价类划分
- 有效等价类：正常输入
- 无效等价类：异常输入

### 2. 边界值分析
- 最小值、最小值+1
- 最大值、最大值-1
- 默认值

### 3. 状态转换测试
- 覆盖所有状态
- 覆盖所有转换路径
- 测试无效转换

### 4. 错误猜测
- 文件缺失
- 网络异常
- 权限不足
- 资源不足

---

## 注意事项

1. 确保飞书 MCP 服务已配置并可用
2. 需要有权限访问对应的飞书项目单和云文档
3. **【重要】如果存在PRD文档，必须针对其中的UI和交互设计生成测试用例**
4. **【重要】多个技术文档链接时，需要全部读取并分类处理**
5. **【重要】涉及版本迭代时，必须设计新旧软件/固件兼容性测试用例**
6. **【重要】必须执行覆盖度检查步骤，确保测试点完整覆盖**
7. 输出总结时必须展示验收标准的覆盖情况和覆盖度检查报告
8. 生成的 Markdown 文件可用 VS Code markmap 插件或其他 markmap 工具渲染查看
